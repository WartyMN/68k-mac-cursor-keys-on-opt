/* * badge.c * *  Created on: May 4, 2025 *      Author: micahbly *//*****************************************************************************//*                                Includes                                   *//*****************************************************************************/// project includes// C includes// Platform includes#include <Events.h>#include <Fonts.h>#include <Icons.h>#include <Memory.h>#include <OSUtils.h>#include <QuickDraw.h>#include <Resources.h>#include <SetUpA4.h>#include <Traps.h>#include <Types.h>/*****************************************************************************//*                               Definitions                                 *//*****************************************************************************/#define ALWAYS_ADVANCE_POSITION		true	// we don't need to draw badge twice in same spot// MB note May 2025:// the show icon code is loosely copied from: https://developer.apple.com/library/archive/samplecode/ShowInitIcon/Listings/ShowInitIcon_c.html// ----------------------------------------------------------------------------// The ShowINIT mechanism works by having each INIT read/write data from these // globals. Only one macro is defined per variable; there is no need to define // a Set and a Get accessor like in <LowMem.h>.#define LMVCoord		(* (short*) 0x92A)#define LMVCheckSum		(* (short*) 0x928)#define LMHCoord		(* (short*) 0x92C)#define LMHCheckSum		(* (short*) 0x92E)// ----------------------------------------------------------------------------/*****************************************************************************//*                             Global Variables                              *//*****************************************************************************/extern Boolean			global_color_qd_available;extern Boolean			global_bw_only;		// color QD doesn't necessarily mean color available/*****************************************************************************//*                       Private Function Prototypes                         *//*****************************************************************************/// Ensure that the data in there was left by another ShowINIT-aware INIT.static unsigned short CheckSum (unsigned short x);// Compute where the icon should be displayed.static void ComputeIconRect (Rect* iconRect, Rect* screenBounds);// Updates the shared global variables so that the next extension will draw its icon beside oursstatic void AdvanceIconPosition (Rect* iconRect);//static void DrawBWIcon (short iconID, Rect *iconRect);/*****************************************************************************//*                       Private Function Definitions                        *//*****************************************************************************/// ----------------------------------------------------------------------------// A checksum is used to make sure that the data in there was left by another ShowINIT-aware INIT.static unsigned short CheckSum (unsigned short x){	return ((x << 1) | (x >> 15)) ^ 0x1021;}// ----------------------------------------------------------------------------// ComputeIconRect computes where the icon should be displayed.static void ComputeIconRect (Rect* iconRect, Rect* screenBounds){	if (CheckSum(LMHCoord) != LMHCheckSum)				// If we are first, we need to initialize the shared data.		LMHCoord = 8;	if (CheckSum(LMVCoord) != LMVCheckSum)		LMVCoord = screenBounds->bottom - 40;	if (LMHCoord + 34 > screenBounds->right) {			// Check whether we must wrap		iconRect->left = 8;		iconRect->top = LMVCoord - 40;	}	else {		iconRect->left = LMHCoord;		iconRect->top = LMVCoord;	}	iconRect->right = iconRect->left + 32;	iconRect->bottom = iconRect->top + 32;}// ----------------------------------------------------------------------------// AdvanceIconPosition updates the shared global variables so that the next extension will draw its icon beside ours.static void AdvanceIconPosition (Rect* iconRect){	LMHCoord = iconRect->left + 40;						// Update the shared data	LMVCoord = iconRect->top;	LMHCheckSum = CheckSum(LMHCoord);	LMVCheckSum = CheckSum(LMVCoord);}/*****************************************************************************//*                        Public Function Definitions                        *//*****************************************************************************/// Display the passed icon as a badge at the bottom of the screen// and advance the system's next draw location for badges for other INITspascal void Badge_Show (short iconFamilyID){	Rect			destRect;	BitMap			sourceBits;	BitMap*			destinationBits;	Handle			iconHandle;	// LOGIC:	//   The Splash screen is open	//   The Welcome to Macintosh window is open	//   We need to draw to the screen, not to the window, because goal is icon 	//     at bottom of screen and drawing to window will get clipped to window	//   It is REQUIRED that InitGraf has been completed already!		// Get a handle to the icon or give up	if ((iconHandle = Get1Resource('ICN#', iconFamilyID)) == NULL)	{		//SysBeep(1);		return;	}	HLock(iconHandle);		// tell QuickDraw that all drawing commands go to the screen directly	SetPort(qd.thePort);	// Destination is the screen's bitmap, pointed to by the global screenBits	destinationBits = &qd.screenBits;	// Compute where the icon should be drawn	ComputeIconRect(&destRect, &qd.screenBits.bounds);		  	if (qd.thePort == NULL || qd.thePort->portBits.baseAddr == NULL) {		SysBeep(1); return;	}	if (qd.screenBits.baseAddr == NULL) {		SysBeep(1); return;	}	// temp debug		//SetRect(&destRect, 50,50, 82, 82);	PaintRect(&destRect);	//SetRect(&destRect, 150,150, 182, 182);		return;		// Prepare the source BitMap description for the ICN# data	// Assuming a standard 32x32 pixel ICN#	sourceBits.rowBytes = 4; // 32 pixels * 1 bit/pixel / 8 bits/byte = 4	SetRect(&sourceBits.bounds, 0, 0, 32, 32); // Bounds are 32x32	// --- Draw the Icon ---	// 1. Apply the mask (clears the area where the icon will draw)	//    The mask data typically follows the icon data in an ICN#.	//    Offset for a 32x32 icon = 32 rows * 4 bytes/row = 128 bytes.	sourceBits.baseAddr = *iconHandle + 128;	CopyBits(&sourceBits,        // Source: The mask part of the ICN#			 destinationBits,    // Destination: The screen buffer			 &sourceBits.bounds, // Source Rect: Whole 32x32 area			 &destRect,           // Destination Rect: Position on screen			 srcBic,             // Mode: Black Is Clear (apply mask)			 nil);               // No clipping region	// 2. Draw the actual icon image	//    The icon image data is at the start of the handle.	sourceBits.baseAddr = *iconHandle; // Point to the start for the icon data	CopyBits(&sourceBits,        // Source: The icon part of the ICN#			 destinationBits,    // Destination: The screen buffer			 &sourceBits.bounds, // Source Rect: Whole 32x32 area			 &destRect,           // Destination Rect: Position on screen			 srcOr,              // Mode: Paint icon bits onto destination			 nil);               // No clipping region	// --- Cleanup ---	HUnlock(iconHandle);	ReleaseResource(iconHandle); // Good practice after Get1Resource	// position next INIT/extension to draw its badge next to instead of on top of ours	AdvanceIconPosition (&destRect);}